name: Manual Package Publish & Release

on:
  # Allows manual triggering via the GitHub UI ('Run workflow' button)
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Type of version bump (patch, minor, or major)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      id-token: write # Allows OIDC token generation (Required for Trusted Publishing)
      contents: read  # Allows checking out the repository

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: âš™ï¸ Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://npm.pkg.github.com/'
          # NOTE: registry-url is no longer required for authentication
          # but should be included if you need to use npm commands for
          # private registries/scopes, or older npm versions.
      - name: Update npm
        run: npm install -g npm@latest
          
      - name: â¬‡ï¸ Install dependencies
        run: npm ci
        
      # This is needed for the 'npm version' command to create a commit/tag
      - name: ğŸ”„ Set up Git User
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

      - name: â¬†ï¸ Determine and Bump Version
        id: versioning
        run: |
          # The type of bump (patch, minor, major) is passed from the manual trigger input
          BUMP_TYPE="${{ github.event.inputs.version_bump }}"
          
          # 1. Run npm version to update package.json, create a commit, and create a tag
          # The -m argument includes [skip ci] to prevent infinite loop re-triggers
          npm version $BUMP_TYPE -m "chore(release): publish v%s [skip ci]"
          
          # 2. Extract the new version number from the created tag
          NEW_TAG=$(git describe --tags --abbrev=0)
          NEW_VERSION=${NEW_TAG:1} # Strip 'v' prefix
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Build package
        run: npm run build --registry=https://npm.pkg.github.com/
        
          
      - name: ğŸš€ Publish to npm
        run: npm publish

      - name: ğŸ’¾ Push New Version Commit and Tag to GitHub
        # This pushes the commit and tag created by 'npm version'
        run: |
          # Push the commit (package.json change) and the tag
          # Assumes your primary branch is 'main'
          git push origin HEAD:main
          git push --tags
        
      - name: â¬†ï¸ Determine and Bump Version
        id: bump-version
        run: |
          # The type of bump (patch, minor, major) is passed from the manual trigger input
          BUMP_TYPE="${{ github.event.inputs.version_bump }}"
          
          # 1. Run npm version to update package.json, create a commit, and create a tag
          # The -m argument includes [skip ci] to prevent infinite loop re-triggers
          npm version $BUMP_TYPE -m "chore(release): publish v%s [skip ci]"
          
          # 2. Extract the new version number from the created tag
          NEW_TAG=$(git describe --tags --abbrev=0)
          NEW_VERSION=${NEW_TAG:1} # Strip 'v' prefix
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: ğŸ“ Create GitHub Release
        # Uses the official action to generate a clean Release UI object
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ steps.versioning.outputs.NEW_TAG }}
          name: Release ${{ steps.versioning.outputs.NEW_TAG }}
          body: |
            ## ğŸ‰ Automated Release
            
            This release was automatically published via the GitHub Actions workflow.
            
            **Version Bump Type:** ${{ github.event.inputs.version_bump }}
          draft: false
          prerelease: false